name: Deploy to Dev Server
on:
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to dev server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ secrets.PROJECT_PATH }}
            git fetch origin develop
            git checkout develop
            git pull origin develop

            # Добавьте здесь дополнительные команды если нужно (очистка кеша, обновление зависимостей и т.д.)
            # например:
            # php composer.phar install --no-dev
            # php bitrix:clear:cache
          EOF

      - name: Notify about successful deployment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ Изменения успешно развернуты на dev сервере'
            })

      - name: Notify about deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Ошибка при развертывании на dev сервере'
            })

  check_conflicts:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged != true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for merge conflicts
        run: |
          git fetch origin develop
          if git merge-tree $(git merge-base HEAD develop) HEAD develop | grep -i "<<<<<"; then
            echo "::error::Обнаружены конфликты слияния!"
            exit 1
          fi

      - name: Notify about conflicts
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ Обнаружены конфликты слияния. Пожалуйста, разрешите конфликты перед мерджем.'
            })
