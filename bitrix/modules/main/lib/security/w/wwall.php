<? namespace Bitrix\Main\Security\W;$GLOBALS['____306541693']= array(base64_decode('dGltZQ'.'=='),base64_decode('dGl'.'tZQ'.'='.'='),base64_decode('anNvbl'.'9kZ'.'WN'.'vZGU='),base64_decode('Y'.'XJyYXlfb'.'WVyZ2U'.'='),base64_decode('am9pbg=='),base64_decode('am9'.'pbg=='),base64_decode('am'.'9pbg=='),base64_decode('Y'.'X'.'JyYX'.'lf'.'cG9w'),base64_decode('YX'.'JyY'.'Xlfc2hpZnQ='),base64_decode('YXJ'.'yYXlfc2h'.'pZnQ='),base64_decode('YXJy'.'Y'.'Xlfc2hpZ'.'nQ='),base64_decode('YX'.'JyYXlfc2hpZnQ='),base64_decode(''.'YXJyYXlfbWVyZ2U='),base64_decode('aXNfYXJyY'.'Xk='),base64_decode('Y'.'XJyY'.'Xlf'.'bWVyZ2U='),base64_decode('aW5'.'fYX'.'JyYXk='),base64_decode('aW5'.'fYXJyYX'.'k'.'='),base64_decode('aW'.'5fYXJyYX'.'k='),base64_decode(''.'a'.'W5f'.'YXJyYXk'.'='),base64_decode('aW5fY'.'XJy'.'YXk='),base64_decode(''.'d'.'Gl'.'tZ'.'Q=='),base64_decode('dGl'.'tZQ'.'=='),base64_decode('YXJ'.'yY'.'XlfbWFw'),base64_decode('Z2V'.'0X2xvYW'.'Rl'.'Z'.'F9'.'l'.'eHRlbnN'.'pb25'.'z'),base64_decode('anNv'.'bl9'.'lbmNvZGU='),base64_decode('a'.'nN'.'vbl'.'9lbmNvZG'.'U='),base64_decode('cG'.'hwdmVy'.'c'.'2lvbg=='),base64_decode('anNvbl9'.'lb'.'mN'.'vZGU'.'='),base64_decode('am9pb'.'g=='));if(!function_exists(__NAMESPACE__.'\\___1803625285')){function ___1803625285($_772540067){static $_726106286= false; if($_726106286 == false) $_726106286=array('V1'.'dB'.'TExfTE'.'9'.'DS'.'w==','c2VjdXJp'.'dHk=','REF'.'UQQ==','eyI=','V1dB'.'TEx'.'fTE9DSw==',''.'c2VjdX'.'Jpd'.'Hk=','U'.'0V'.'DVVJJVFlf'.'V1dBTEx'.'f'.'RVhDRVBUSU9O','RkFJTF9DSEVDS0'.'lORw==','Q2FuIG5vdC'.'B'.'leGVjdXRlIHd3YW'.'xsIHJ'.'1bGVzOiA=','IFRyYWNlOiA=','UkVRVUVTV'.'F9VUkk=','a2V5cw='.'=','dmFsdWVz','U0VD'.'VVJJVFlfV1'.'dBTEx'.'fTU9ESUZZ','Lg==','U0'.'V'.'DVV'.'JJVFlf'.'V'.'1dB'.'T'.'ExfVU5'.'TRVQ=','Lg==',''.'U0V'.'D'.'VVJJ'.'VFlfV1dBT'.'Ex'.'fRVhJVA==','Lg'.'='.'=','Z2'.'x'.'vYmFs','a2V5cw==','dmFsdWVz','Z2V0','Z'.'2V0','cG9'.'zdA='.'=','cG9zdA='.'=','Y2'.'9'.'va2ll','Y29'.'v'.'a2l'.'l',''.'cmVxdWVzd'.'A==','cm'.'Vxd'.'WVzd'.'A==',''.'Z'.'2xvYmFs','Z2xvYmFs','b'.'W'.'Fpbl9z'.'ZWM=','V1dB'.'TExfQU'.'N'.'UVUFM'.'SVpF'.'X1'.'JVTEVT','dg='.'=','dmVyc2'.'lvb'.'g==','aQ==','aXNJ'.'bnN0YWx'.'s'.'ZWQ=','d'.'g='.'=','a'.'W5p','bW9kdWxlcw==','bGljZW5zZQ==','c'.'G'.'hw','dg'.'='.'=',''.'ZXh0','c2VjdXJpdHk=','Z'.'GI=','dHlw'.'ZQ==','Z'.'GI=',''.'d'.'mVyc2'.'lvbg==','ZGI=','d'.'HlwZQ'.'==','ZGI=',''.'d'.'HlwZQ'.'==',''.'dmV'.'yc'.'2'.'lvbg==',''.'ZGI=','d'.'mVyc2lvb'.'g==','ZW52aXJvbm'.'1lbnQ'.'=',''.'dm1fdmVyc2'.'lvbg==','dm'.'0=','dg==',''.'ZW5'.'2aXJvbm'.'1'.'lbnQ=','dm1'.'fd'.'mVy'.'c2l'.'v'.'bg==','c'.'29ja'.'2V0'.'VGltZW91dA'.'='.'=','c3R'.'yZWF'.'tVGltZW91dA==',''.'K'.'Cc'.'=','ZGF0YQ==','JywgJw='.'=','bW9kd'.'W'.'xl','JywgJw==','bW'.'9kdWx'.'lX3Z'.'lcn'.'Npb24'.'=',''.'Jyk'.'=','L'.'C'.'A=','U'.'0VDVVJJVF'.'l'.'fV'.'1dBTExfR'.'V'.'h'.'DR'.'VBUSU9'.'O','bWFpbg==',''.'RkFJT'.'F9'.'SR'.'U'.'ZSRVNIS'.'U'.'5H',''.'Q2FuIG5vdCByZWZy'.'ZXNoI'.'Hd3'.'YW'.'xsIH'.'J1bGVzOiA=','IF'.'R'.'yYWNlOi'.'A'.'=','Z'.'G'.'F0Y'.'Q==','eyI=','LS0t'.'LS1CR'.'U'.'d'.'JTiBQV'.'U'.'JMS'.'UMgS'.'0VZ'.'LS'.'0tLS0'.'=',''.'Ck1JSUJJakFOQmd'.'rcW'.'hraUc5dzBCQVFFRkF'.'B'.'T'.'0NBUThBTUlJQk'.'N'.'nS0NB'.'UUVBcThRR'.'TBIam1ISlVT'.'dFdWNm4'.'wem'.'E'.'KUlZvTHgwMkt6YmZyYlMvUDZzV2'.'F4'.'VH'.'p3OFNlR1'.'R0'.'YlRDT3Jw'.'SGk1'.'UUY2T1J5alovWHh6L0'.'tMVTFHYm9mOUNaMwo0ejdTa3F'.'VdDY2aWJ'.'Y'.'dk'.'9'.'G'.'Qng0ZncvQVBQUkdEc'.'XRtMG5EM2Zn'.'R'.'3N1'.'M'.'1J'.'lUGd3M'.'j'.'lpOCt2bTdtdEJLSlVZbDRyClZ'.'wYj'.'ZzZlp'.'FVDlLRWI2'.'VD'.'F'.'IRFl'.'t'.'RXZjMWhx'.'L2lp'.'dXl4THJ'.'a'.'Wmk1'.'UTZVZm'.'Y0VUV2VEkrNj'.'hzc0ZSa'.'1Erb'.'3dU'.'Un'.'kK'.'ZU9JTWJG'.'aE0v'.'V'.'VRtZ'.'lZZYlR'.'SRnk'.'yb'.'1VROF'.'dNemEybko1U'.'2F'.'oem'.'kxVUtPMWpBalhUUFJye'.'mM3QWp1NjM5'.'ajFP'.'MA'.'pwcHFmbTV4Z1dsRkF'.'Ka0hRVGd'.'i'.'ZGQ1QVdxREZR'.'a'.'3Q5S'.'Et'.'rWS'.'t'.'UbmZCTEdWTXZWeVB3VE'.'hOV1F'.'ZQ'.'Xc0eHBnL3dBClp3SURBUUFCCi0'.'tLS0t'.'RU5E'.'IFBVQ'.'kxJQyBLRVktLS0t'.'LQ==');return base64_decode($_726106286[$_772540067]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1154271296= 'https://wwall.bitrix.info/rules.php'; protected $_467699791= true; public function handle(){ try{  $_1721048373= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1721048373)){ return;}  $_1590758524= Cache::createInstance(); $_1544173550= false; if($_1590758524->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_882169995= $_1590758524->getVars(); if($GLOBALS['____306541693'][0]()- $_882169995> round(0+20)){  $_1723070831= Application::getConnection(); $_1285170942= RuleRecordTable::getTableName(); $_1723070831->truncateTable($_1285170942); RuleRecordTable::cleanCache(); $_1590758524->clean(___1803625285(0), ___1803625285(1));}} elseif($_1590758524->startDataCache()){  $_1590758524->endDataCache($GLOBALS['____306541693'][1]()); $_1544173550= true;} foreach($_1721048373 as $_800516288){ $_1459045551= new PublicKeyCipher; $_1682030699= $_1459045551->decrypt($_800516288[___1803625285(2)], static::__48101616()); if(!str_starts_with($_1682030699, ___1803625285(3))){ continue;} $_889519783= $GLOBALS['____306541693'][2]($_1682030699, true); if(!empty($_889519783)){ $_1623499646= Rule::make($_889519783); $_316559519= $this->handleRule($_1623499646); $this->applyHandlingResults($_316559519);}}  if($_1544173550){ $_1590758524->clean(___1803625285(4), ___1803625285(5));}} catch(\Throwable $_1061861867){ $this->logEvent( ___1803625285(6), ___1803625285(7), ___1803625285(8). $_1061861867->getMessage(). ___1803625285(9). $_1061861867->getTraceAsString());}}  public function handleRule(Rule $_1623499646): array{ $_316559519=[]; if($_1623499646->matchPath($_SERVER[___1803625285(10)])){  $_1810685386= $this->getContextElements($_1623499646->getContext()); foreach($_1810685386 as $_1032648867 => &$_395362434){ $_316559519= $GLOBALS['____306541693'][3]($_316559519, $this->recursiveContextKeyHandle($_1032648867, $_395362434,[], $_1623499646));}} return $_316559519;}  public function applyHandlingResults(array $_316559519){ $_1810685386= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_316559519 as $_1162827255){ $_395362434=& $_1810685386[$_1162827255->getContextName()]; $_1579962236= $_1162827255->getRuleResult(); $_1623499646= $_1162827255->getRule(); if($_1579962236 instanceof ModifyResult){ if($_1623499646->getProcess() === ___1803625285(11)){  static::rewriteContextKey( $_1162827255->getContextName(), $_395362434, $_1162827255->getContextKey(), $_1579962236->getCleanValue());} elseif($_1623499646->getProcess() === ___1803625285(12)){ static::rewriteContextValue( $_1162827255->getContextName(), $_395362434, $_1162827255->getContextKey(), $_1579962236->getCleanValue());} $this->logEvent( ___1803625285(13), $_1162827255->getContextName(), $GLOBALS['____306541693'][4](___1803625285(14), $_1162827255->getContextKey()));} elseif($_1579962236 instanceof CheckResult &&!$_1579962236->isSuccess()){ if($_1579962236->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1162827255->getContextName(), $_395362434, $_1162827255->getContextKey(),); $this->logEvent( ___1803625285(15), $_1162827255->getContextName(), $GLOBALS['____306541693'][5](___1803625285(16), $_1162827255->getContextKey()));} elseif($_1579962236->getAction() === RuleAction::EXIT){ $this->logEvent( ___1803625285(17), $_1162827255->getContextName(), $GLOBALS['____306541693'][6](___1803625285(18), $_1162827255->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_467699791= false;} protected function rewriteContextKey($_1032648867, &$_395362434, $_1170172369, $_1211063060){ $_1744379888= $_1170172369;  $GLOBALS['____306541693'][7]($_1744379888); $_1744379888[]= $_1211063060; if($_1032648867 === ___1803625285(19)){ $_387007138= $GLOBALS['____306541693'][8]($_1170172369); $GLOBALS['____306541693'][9]($_1744379888); if(empty($_1170172369)){ $GLOBALS[$_1211063060]= $GLOBALS[$_387007138]; unset($GLOBALS[$_387007138]);} else{ $_395362434=& $GLOBALS[$_387007138]; $_1704323344= ArrayHelper::getByNestedKey($_395362434, $_1170172369);  ArrayHelper::setByNestedKey($_395362434, $_1744379888, $_1704323344);  ArrayHelper::unsetByNestedKey($_395362434, $_1170172369);}} else{ $_1704323344= ArrayHelper::getByNestedKey($_395362434, $_1170172369);  ArrayHelper::setByNestedKey($_395362434, $_1744379888, $_1704323344);  ArrayHelper::unsetByNestedKey($_395362434, $_1170172369);}} protected function rewriteContextValue($_1032648867, &$_395362434, $_1874352409, $_1704323344){ if($_1032648867 === 'global'){ $_387007138= $GLOBALS['____306541693'][10]($_1874352409); if(empty($_1874352409)){ $GLOBALS[$_387007138]= $_1704323344;} else{ $_395362434=& $GLOBALS[$_387007138]; ArrayHelper::setByNestedKey($_395362434, $_1874352409, $_1704323344);}} else{  ArrayHelper::setByNestedKey($_395362434, $_1874352409, $_1704323344);}} protected function unsetContextValue($_1032648867, &$_395362434, $_1874352409){ if($_1032648867 === 'global'){ $_387007138= $GLOBALS['____306541693'][11]($_1874352409); if(empty($_1874352409)){ unset($GLOBALS[$_387007138]);} else{ $_395362434=& $GLOBALS[$_387007138]; ArrayHelper::unsetByNestedKey($_395362434, $_1874352409);}} else{ ArrayHelper::unsetByNestedKey($_395362434, $_1874352409);}}  protected function recursiveContextKeyHandle(string $_1032648867, array &$_395362434, array $_1039105828, Rule $_1623499646): array{  $_316559519=[]; foreach($_395362434 as $_1207536426 => $_1704323344){ $_1874352409= $GLOBALS['____306541693'][12]($_1039105828,[$_1207536426]); if($_1623499646->matchKey($_1874352409)){  if($_1623499646->getProcess() === ___1803625285(20)){ $_1579962236= $_1623499646->evaluate($_1207536426);} elseif($_1623499646->getProcess() === ___1803625285(21)){ $_1579962236= $_1623499646->evaluateValue($_1704323344);}  if(!empty($_1579962236) && $_1579962236 instanceof RuleResult){ $_316559519[]= new HandlingResult($_1032648867, $_1874352409, $_1579962236, $_1623499646);}}  if($GLOBALS['____306541693'][13]($_1704323344)){ $_316559519= $GLOBALS['____306541693'][14]($_316559519, $this->recursiveContextKeyHandle( $_1032648867, $_395362434[$_1207536426], $_1874352409, $_1623499646));}} return $_316559519;} protected function getContextElements(array $_201783019){ $_1145232475=[]; if($GLOBALS['____306541693'][15](___1803625285(22), $_201783019, true)){ $_1145232475[___1803625285(23)]= &$_GET;} if($GLOBALS['____306541693'][16](___1803625285(24), $_201783019, true)){ $_1145232475[___1803625285(25)]= &$_POST;} if($GLOBALS['____306541693'][17](___1803625285(26), $_201783019, true)){ $_1145232475[___1803625285(27)]= &$_COOKIE;} if($GLOBALS['____306541693'][18](___1803625285(28), $_201783019, true)){ $_1145232475[___1803625285(29)]= &$_REQUEST;} if($GLOBALS['____306541693'][19](___1803625285(30), $_201783019, true)){ $_1145232475[___1803625285(31)]= $GLOBALS;} return $_1145232475;} public static function refreshRules(){ try{ $_307016629= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____306541693'][20]()- $_307016629)< static::CACHE_RULES_TTL){ return;} Option::set(___1803625285(32), ___1803625285(33), $GLOBALS['____306541693'][21]()); $_916930319= null;  $_2104501794= $GLOBALS['____306541693'][22](function($_1663450873){ return[___1803625285(34) => $_1663450873[___1803625285(35)], ___1803625285(36) => (int) $_1663450873[___1803625285(37)]];}, ModuleManager::getModulesFromDisk());  $_115494591=[]; foreach($GLOBALS['____306541693'][23]() as $_931879246){ $_454803889= new ReflectionExtension($_931879246); $_115494591[$_931879246]=[ ___1803625285(38) => $_454803889->getVersion(), ___1803625285(39) => $_454803889->getINIEntries()];} $_1480935458=[ ___1803625285(40) => $GLOBALS['____306541693'][24]($_2104501794), ___1803625285(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1803625285(42) => $GLOBALS['____306541693'][25]([ ___1803625285(43) => $GLOBALS['____306541693'][26](), ___1803625285(44) => $_115494591])]; if(Loader::includeModule(___1803625285(45))){ $_240509367= CSecuritySystemInformation::getSystemInformation(); if(isset($_240509367[___1803625285(46)][___1803625285(47)]) && isset($_240509367[___1803625285(48)][___1803625285(49)])){ $_1480935458[___1803625285(50)]=[ ___1803625285(51) => $_240509367[___1803625285(52)][___1803625285(53)], ___1803625285(54) => $_240509367[___1803625285(55)][___1803625285(56)]];} if(isset($_240509367[___1803625285(57)][___1803625285(58)])){ $_1480935458[___1803625285(59)]=[___1803625285(60) => $_240509367[___1803625285(61)][___1803625285(62)]];}}  $_1855636028= new HttpClient([ ___1803625285(63) => round(0+5), ___1803625285(64) => round(0+1+1+1+1+1)]); $_94309118= $_1855636028->post( static::$_1154271296, $_1480935458); if($_1855636028->getStatus() == round(0+50+50+50+50) &&!empty($_94309118)){ $_916930319= Json::decode($_94309118);}  if($_916930319 !== null){ $_1723070831= Application::getConnection(); $_1285170942= RuleRecordTable::getTableName(); if(!empty($_916930319)){ foreach($_916930319 as $_1448268654){ if(!static::checkRuleSign($_1448268654)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____306541693'][27]($_1448268654));}}}  $_1723070831->truncateTable($_1285170942);  if(!empty($_916930319)){ $_37190906=[]; foreach($_916930319 as $_1448268654){ $_37190906[]= ___1803625285(65). $_1723070831->getSqlHelper()->forSql($_1448268654[___1803625285(66)]). ___1803625285(67). $_1723070831->getSqlHelper()->forSql($_1448268654[___1803625285(68)]). ___1803625285(69). $_1723070831->getSqlHelper()->forSql($_1448268654[___1803625285(70)]). ___1803625285(71);} $_1207475375= $GLOBALS['____306541693'][28](___1803625285(72), $_37190906);  $_1723070831->query("INSERT INTO {$_1285170942} (DATA, MODULE, MODULE_VERSION) VALUES {$_1207475375}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1061861867){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1803625285(73), ___1803625285(74), ___1803625285(75), ___1803625285(76). $_1061861867->getMessage(). ___1803625285(77). $_1061861867->getTraceAsString());}} protected static function checkRuleSign($_1623499646){ $_1459045551= new PublicKeyCipher; $_889519783= $_1459045551->decrypt($_1623499646[___1803625285(78)], static::__48101616()); return str_starts_with($_889519783, ___1803625285(79));} private static function __48101616(){ $_1010417982= ''; $_1010417982 .= ___1803625285(80); $_1010417982 .= ___1803625285(81); return $_1010417982;} protected function logEvent($_255300517, $_374769645, $_2064475053){ if($this->_467699791){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_255300517, 'main', $_374769645, $_2064475053);}}}?>